---
import { SITE } from "@/siteConfig";

import Introduction from "@/components/Introduction.astro";
import IconLink from "@/components/IconLink.astro";
import CustomLink from "@/components/CustomLink.astro";
import NavigationLink from "@/components/NavigationLink.astro";

interface Props {
  title?: string;
  bio?: string;
  links?: any[];
  profileImage?: string;
  imageScale?: string;
  hideCountdown?: boolean;
}

const { title, bio, links = SITE.customLinks, profileImage, imageScale, hideCountdown = false } = Astro.props;

// Determine if we should place bottom link in penultimate position
const shouldPlaceBottomLinkBeforeLast = Astro.url.pathname.startsWith('/clases') || Astro.url.pathname.startsWith('/salud');
---

<Introduction title={title} bio={bio} profileImage={profileImage} imageScale={imageScale} hideCountdown={hideCountdown} />

<ul id="custom-links-list" class="grid gap-y-6 pb-12 pt-4 text-center">
  <!-- Dynamic Top Link -->
  <li id="top-link-item" class="hidden">
     <a id="top-link-anchor" href="#" target="_blank" rel="noopener noreferrer" class="hover:bg-lightModeCustomLinkBackgroundHover dark:hover:bg-darkModeCustomLinkBackgroundHover hover:ring-lightModeCustomLinkOutlineHover dark:hover:ring-darkModeCustomLinkOutlineHover hover:text-lightModeCustomLinkTextHover dark:hover:text-darkModeCustomLinkTextHover flex items-center justify-center gap-2 rounded-full bg-lightModeCustomLinkBackground px-6 py-3 text-lg text-lightModeCustomLinkText ring-2 ring-lightModeCustomLinkOutline transition-all duration-200 ease-in-out hover:scale-105 dark:bg-darkModeCustomLinkBackground dark:text-darkModeCustomLinkText dark:ring-darkModeCustomLinkOutline">
     </a>
  </li>

  {
    shouldPlaceBottomLinkBeforeLast ? (
      // For /clases and /salud: render all except last, then bottomLink, then last
      <>
        {links.slice(0, -1).map((link) => (
          <CustomLink url={link.url} text={link.title}>{link.title}</CustomLink>
        ))}
        
        <!-- Dynamic Bottom Link (penultimate position) -->
        <li id="bottom-link-item" class="hidden">
           <a id="bottom-link-anchor" href="#" class="hover:bg-lightModeCustomLinkBackgroundHover dark:hover:bg-darkModeCustomLinkBackgroundHover hover:ring-lightModeCustomLinkOutlineHover dark:hover:ring-darkModeCustomLinkOutlineHover hover:text-lightModeCustomLinkTextHover dark:hover:text-darkModeCustomLinkTextHover flex items-center justify-center gap-2 rounded-full bg-lightModeCustomLinkBackground px-6 py-3 text-lg text-lightModeCustomLinkText ring-2 ring-lightModeCustomLinkOutline transition-all duration-200 ease-in-out hover:scale-105 dark:bg-darkModeCustomLinkBackground dark:text-darkModeCustomLinkText dark:ring-darkModeCustomLinkOutline">
           </a>
        </li>
        
        {links.length > 0 && (
          <CustomLink url={links[links.length - 1].url} text={links[links.length - 1].title}>{links[links.length - 1].title}</CustomLink>
        )}
      </>
    ) : (
      // For home page: render all links, then bottomLink at the end
      <>
        {links.map((link) => (
          <CustomLink url={link.url} text={link.title}>{link.title}</CustomLink>
        ))}
        
        <!-- Dynamic Bottom Link (last position) -->
        <li id="bottom-link-item" class="hidden">
           <a id="bottom-link-anchor" href="#" class="hover:bg-lightModeCustomLinkBackgroundHover dark:hover:bg-darkModeCustomLinkBackgroundHover hover:ring-lightModeCustomLinkOutlineHover dark:hover:ring-darkModeCustomLinkOutlineHover hover:text-lightModeCustomLinkTextHover dark:hover:text-darkModeCustomLinkTextHover flex items-center justify-center gap-2 rounded-full bg-lightModeCustomLinkBackground px-6 py-3 text-lg text-lightModeCustomLinkText ring-2 ring-lightModeCustomLinkOutline transition-all duration-200 ease-in-out hover:scale-105 dark:bg-darkModeCustomLinkBackground dark:text-darkModeCustomLinkText dark:ring-darkModeCustomLinkOutline">
           </a>
        </li>
      </>
    )
  }
</ul>

<script>
  function applyConfig() {
    const path = window.location.pathname;
    let key = 'appConfig';
    if (path.startsWith('/clases')) key = 'clasesConfig';
    if (path.startsWith('/salud')) key = 'saludConfig';

    // Initialize default links for salud if not set
    if (key === 'saludConfig') {
      const existingConfig = JSON.parse(localStorage.getItem(key) || '{}');
      
      // Set default top link if not exists
      if (!existingConfig.topLink || (!existingConfig.topLink.title && !existingConfig.topLink.url)) {
        existingConfig.topLink = {
          title: '<‚öô/> Taller de Ajedrez',
          url: 'https://ajedrezfamaf.com/'
        };
      }
      
      // Set default bottom link if not exists
      if (!existingConfig.bottomLink || (!existingConfig.bottomLink.title && !existingConfig.bottomLink.url)) {
        existingConfig.bottomLink = {
          title: '<‚öô/> Obra Social PASOS',
          url: 'https://unc.edu.ar/vida-estudiantil/pasos'
        };
      }
      
      localStorage.setItem(key, JSON.stringify(existingConfig));
    }

    // Initialize default bottom link for clases if not set
    if (key === 'clasesConfig') {
      const existingConfig = JSON.parse(localStorage.getItem(key) || '{}');
      
      // Set default bottom link if not exists
      if (!existingConfig.bottomLink || (!existingConfig.bottomLink.title && !existingConfig.bottomLink.url)) {
        existingConfig.bottomLink = {
          title: '<‚öô/> Click para agregar tus propios links',
          url: '/config'
        };
        localStorage.setItem(key, JSON.stringify(existingConfig));
      }
    }

    // Initialize default bottom link for home page if not set
    if (key === 'appConfig') {
      const existingConfig = JSON.parse(localStorage.getItem(key) || '{}');
      
      // Set default top link if not exists
      if (!existingConfig.topLink || (!existingConfig.topLink.title && !existingConfig.topLink.url)) {
        existingConfig.topLink = {
          title: '<‚öô/> Autogesti√≥n (Guaran√≠ UNC)',
          url: 'https://autogestion.guarani.unc.edu.ar/'
        };
      }
      
      // Set default bottom link if not exists
      if (!existingConfig.bottomLink || (!existingConfig.bottomLink.title && !existingConfig.bottomLink.url)) {
        existingConfig.bottomLink = {
          title: '<‚öô/> üîó Bienestar Estudiantil',
          url: '/salud'
        };
      }
      
      localStorage.setItem(key, JSON.stringify(existingConfig));
    }

    const config = JSON.parse(localStorage.getItem(key) || '{}');
    
    // Top Link
    const topItem = document.getElementById('top-link-item');
    const topAnchor = document.getElementById('top-link-anchor') as HTMLAnchorElement;
    if (topItem && topAnchor) {
        if (config.topLink && config.topLink.title && config.topLink.url) {
            topItem.classList.remove('hidden');
            topAnchor.innerText = config.topLink.title;
            topAnchor.href = config.topLink.url;
        } else {
            topItem.classList.add('hidden');
        }
    }

    // Bottom Link
    const bottomItem = document.getElementById('bottom-link-item');
    const bottomAnchor = document.getElementById('bottom-link-anchor') as HTMLAnchorElement;
    if (bottomItem && bottomAnchor) {
        if (config.bottomLink && config.bottomLink.title && config.bottomLink.url) {
            bottomItem.classList.remove('hidden');
            bottomAnchor.innerText = config.bottomLink.title;
            bottomAnchor.href = config.bottomLink.url;
        } else {
            bottomItem.classList.add('hidden');
        }
    }
  }

  document.addEventListener('astro:page-load', () => {
      applyConfig();
      window.addEventListener('config-updated', applyConfig);
  });
</script>

<script>
  // Hide NavigationLink logic (moved from NavigationLink.astro to handle context better or duplicated)
  // Actually, NavigationLink handles its own config 'appConfig'.
  // If we want NavigationLink to disappear on /clases or be controlled by clasesConfig, we should update NavigationLink too.
  // But for now, let's keep Content script focused on Custom Links.
</script>
